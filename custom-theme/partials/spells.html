<div class="spells-app">

    <style>
        /* --- CSS Scoped & Variables --- */
        .spells-app {
            --text-main: var(--md-typeset-color, #333);
            --bg-main: var(--md-default-bg-color, #fff);
            --border: var(--md-default-fg-color--lightest, #eee);
            --primary: var(--md-primary-fg-color, #5c6bc0);

            /* Couleurs Tags (Mode Clair) */
            --t-v-bg: #ffcdd2; --t-v-fg: #b71c1c;
            --t-s-bg: #bbdefb; --t-s-fg: #0d47a1;
            --t-m-bg: #c8e6c9; --t-m-fg: #1b5e20;
            --t-c-bg: #ffe0b2; --t-c-fg: #e65100;
            --t-r-bg: #e1bee7; --t-r-fg: #4a148c;

            font-size: 0.9rem; color: var(--text-main); max-width: 100%; margin: 0 auto;
        }

        /* Couleurs Tags (Mode Sombre) */
        body[data-md-color-scheme="slate"] .spells-app {
            --t-v-bg: rgba(183, 28, 28, 0.3); --t-v-fg: #ffcdd2;
            --t-s-bg: rgba(13, 71, 161, 0.3); --t-s-fg: #bbdefb;
            --t-m-bg: rgba(27, 94, 32, 0.3);  --t-m-fg: #c8e6c9;
            --t-c-bg: rgba(230, 81, 0, 0.3);  --t-c-fg: #ffe0b2;
            --t-r-bg: rgba(74, 20, 140, 0.3); --t-r-fg: #e1bee7;
        }

        .spells-app a { color: var(--md-typeset-a-color, #3f51b5); text-decoration: none; }
        .spells-app a:hover { text-decoration: underline; }

        /* Interface Filtres */
        .controls {
            background: var(--bg-main); border: 1px solid var(--border);
            padding: 15px; border-radius: 4px; margin-bottom: 20px;
            display: flex; gap: 15px; flex-wrap: wrap; justify-content: center;
        }
        .control-group { display: flex; flex-direction: column; flex: 1 1 auto; min-width: 120px; }
        .control-group label { font-weight: bold; font-size: 0.8em; opacity: 0.8; margin-bottom: 4px; color: var(--md-typeset-color); }

        input, select {
            padding: 6px; border: 1px solid #ccc; border-radius: 3px;
            background: var(--bg-main); color: var(--text-main);
        }
        input:focus, select:focus { border-color: var(--primary); outline: none; }

        /* Tableau */
        .table-wrap {
            overflow-x: auto; border: 1px solid var(--border); border-radius: 4px;
            display: flex; justify-content: center; background: var(--bg-main);
        }
        table { width: 100%; border-collapse: collapse; min-width: 800px; margin: 0 auto; }

        th {
            background: var(--primary); color: #fff; padding: 10px; text-align: left;
            white-space: nowrap; user-select: none; cursor: pointer;
        }
        th:hover { opacity: 0.9; }

        td { padding: 8px 10px; border-bottom: 1px solid var(--border); vertical-align: middle; color: var(--text-main); }
        tr:nth-child(even) { background: rgba(128,128,128, 0.05); }
        tr:hover { background: rgba(128,128,128, 0.1); cursor: pointer; }

        /* Classe pour masquer les lignes filtr√©es via JS */
        tr.hidden { display: none; }

        /* Badges */
        .tag {
            display: inline-block; padding: 2px 6px; border-radius: 4px;
            font-size: 0.75em; font-weight: 700; margin: 1px; border: 1px solid transparent;
        }
        .t-v { background: var(--t-v-bg); color: var(--t-v-fg); border-color: var(--t-v-fg); }
        .t-s { background: var(--t-s-bg); color: var(--t-s-fg); border-color: var(--t-s-fg); }
        .t-m { background: var(--t-m-bg); color: var(--t-m-fg); border-color: var(--t-m-fg); }
        .t-c { background: var(--t-c-bg); color: var(--t-c-fg); border-color: var(--t-c-fg); }
        .t-r { background: var(--t-r-bg); color: var(--t-r-fg); border-color: var(--t-r-fg); }
        .t-m.costly { border-width: 2px; text-decoration: underline dotted; }

        .t-cls { border: 1px solid #ccc; background: var(--bg-main); color: var(--text-main); font-weight: normal; }
        .more-cls { cursor: help; border-bottom: 1px dotted; margin-left: 5px; font-weight: bold; opacity: 0.6; color: var(--text-main); }

        /* Modal */
        .modal-overlay {
            display: none; position: fixed; z-index: 9999; left: 0; top: 0;
            width: 100%; height: 100%; background: rgba(0,0,0,0.75); backdrop-filter: blur(2px);
        }
        .modal-box {
            background: var(--bg-main); margin: 5% auto; padding: 25px;
            width: 90%; max-width: 700px; max-height: 85vh; overflow-y: auto;
            border-radius: 6px; position: relative; box-shadow: 0 10px 25px rgba(0,0,0,0.5); color: var(--text-main);
        }
        .close-btn { position: absolute; right: 20px; top: 15px; font-size: 24px; cursor: pointer; opacity: 0.6; }
        .meta-info { font-style: italic; opacity: 0.8; border-bottom: 1px solid var(--border); padding-bottom: 15px; margin-bottom: 15px; line-height: 1.6; }
        .action-link { font-size: 0.8em; margin-left: 8px; opacity: 0.4; text-decoration: none; display: inline-block; vertical-align: middle; }
        .action-link:hover { opacity: 1; transform: scale(1.1); }
    </style>

    <div class="controls">
        <div class="control-group"><label>Recherche</label><input type="text" id="s-search" placeholder="Nom..." disabled></div>
        <div class="control-group"><label>Niveau</label><select id="s-lvl" disabled><option value="all">Tous</option></select></div>
        <div class="control-group"><label>√âcole</label><select id="s-sch" disabled><option value="all">Toutes</option></select></div>
        <div class="control-group"><label>Classe</label><select id="s-cls" disabled><option value="all">Toutes</option></select></div>
        <div class="control-group"><label>Conc.</label><select id="s-conc" disabled><option value="all">-</option><option value="true">Oui</option><option value="false">Non</option></select></div>
        <div class="control-group"><label>Rituel</label><select id="s-rit" disabled><option value="all">-</option><option value="true">Oui</option><option value="false">Non</option></select></div>
    </div>

    <div class="table-wrap">
        <table id="spells-table">
            <thead>
                <tr>
                    <th>Niv.</th>
                    <th>Nom</th>
                    <th>√âcole</th>
                    <th>Temps</th>
                    <th>Comp.</th>
                    <th>Classes</th>
                </tr>
            </thead>
            <tbody id="spells-body">
                <tr><td colspan="6" style="text-align:center; padding: 20px;">Chargement...</td></tr>
            </tbody>
        </table>
    </div>

    <div id="spells-modal" class="modal-overlay">
        <div class="modal-box">
            <span class="close-btn">&times;</span>
            <h2 id="m-title" style="margin-top:0; color:var(--primary); padding-right:30px;"></h2>
            <div id="m-meta" class="meta-info"></div>
            <div id="m-desc"></div>
        </div>
    </div>

    <script>
    (function() {
        const URL_DATA = 'https://eostrebis.github.io/5e.VF/spells.json';
        const URL_BASE = 'https://eostrebis.github.io/5e.VF/sorts/';

        let allSpells = [];

        const ui = {
            search: document.getElementById('s-search'),
            lvl: document.getElementById('s-lvl'),
            sch: document.getElementById('s-sch'),
            cls: document.getElementById('s-cls'),
            conc: document.getElementById('s-conc'),
            rit: document.getElementById('s-rit'),
            tbody: document.getElementById('spells-body'),
            modal: document.getElementById('spells-modal')
        };

        // --- Helpers ---
        const normalize = t => t ? t.toString().toLowerCase().replace(/\u0153/g, "oe").replace(/\u00e6/g, "ae").normalize("NFD").replace(/[\u0300-\u036f]/g, "") : "";
        const slugify = t => normalize(t).replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)+/g, '');
        const formatClass = c => ({ "MagedeGuerre": "Mage de Guerre", "MaitreGuerre": "Ma√Ætre de Guerre" }[c] || c);

        // --- NOUVEAU CALCUL DE POIDS DE TEMPS ROBUSTE ---
        const getTimeWeight = (t) => {
            if (!t) return 9999;
            const txt = t.toString().toLowerCase().trim();

            // 1. Mots-cl√©s fixes
            if (txt.includes('bonus')) return 1;
            if (txt.includes('r√©action') || txt.includes('reaction')) return 2;
            if (txt.includes('action')) return 3;

            // 2. Extraction valeur num√©rique (s√©curis√©e)
            const match = txt.match(/(\d+)/);
            let val = match ? parseInt(match[1], 10) : 0;
            if (isNaN(val)) val = 0;

            // 3. Paliers par unit√©
            if (txt.includes('heure') || txt.includes('hour')) return 1000 + val;
            if (txt.includes('minute')) return 100 + val;
            if (txt.includes('tour') || txt.includes('round')) return 10 + val;

            return 9999; // Fallback
        };

        // --- Fetch ---
        fetch(URL_DATA).then(r => r.json()).then(data => {
            allSpells = Object.entries(data).map(([k, v]) => {
                const lvl = parseInt(v.level) || 0;
                return {
                    id: k, name: k, slug: slugify(k), ...v,
                    levelInt: lvl,
                    sortName: normalize(k),
                    sortSchool: normalize(v.school),
                    sortTimeValue: getTimeWeight(v.Incantation), // Poids pour le tri Tablesort
                    classes: (v.available || []).map(formatClass),
                    isCostly: (v.detailmat || '').toLowerCase().match(/consomme|po|vaut/)
                };
            });

            // TRI INITIAL FORCE (Cantrips en premier)
            allSpells.sort((a, b) => a.levelInt - b.levelInt);

            // Remplir Selects
            [0,1,2,3,4,5,6,7,8,9].forEach(l => ui.lvl.add(new Option(l === 0 ? "Cantrip (0)" : `Niveau ${l}`, l)));
            [...new Set(allSpells.map(s => s.school).filter(Boolean))].sort().forEach(s => ui.sch.add(new Option(s, s)));
            [...new Set(allSpells.flatMap(s => s.classes))].sort().forEach(c => ui.cls.add(new Option(c, c)));

            Object.values(ui).forEach(el => el instanceof HTMLElement && (el.disabled = false));

            [ui.search, ui.lvl, ui.sch, ui.cls, ui.conc, ui.rit].forEach(el => el.addEventListener('input', applyFilters));

            renderTableRows();
            checkHash();

        }).catch(e => ui.tbody.innerHTML = `<tr><td colspan="6" style="color:red;text-align:center">Erreur: ${e.message}</td></tr>`);

        // --- G√©n√©ration des lignes ---
        function renderTableRows() {
            if (!allSpells.length) return;

            ui.tbody.innerHTML = allSpells.map(s => `
                <tr class="spell-row"
                    onclick="window.openSpell('${s.id}')"
                    data-name="${s.sortName} ${normalize(s.englishname)}"
                    data-lvl="${s.levelInt}"
                    data-sch="${s.school}"
                    data-cls="${s.classes.join(',')}"
                    data-conc="${s.Concentration}"
                    data-rit="${s.Rituel}">

                    <td data-sort="${s.levelInt}" style="text-align:center;font-weight:bold">${s.levelInt === 0 ? 'C' : s.levelInt}</td>
                    <td data-sort="${s.sortName}" style="font-weight:500;color:var(--primary)">${s.name}</td>
                    <td data-sort="${s.sortSchool}">${s.school}</td>

                    <td data-sort="${s.sortTimeValue}">${s.Incantation}</td>

                    <td>${getCompTags(s)}</td>
                    <td>${getClassTags(s.classes)}</td>
                </tr>
            `).join('');
        }

        // --- Filtrage par CSS ---
        function applyFilters() {
            const q = normalize(ui.search.value);
            const fLvl = ui.lvl.value;
            const fSch = ui.sch.value;
            const fCls = ui.cls.value;
            const fConc = ui.conc.value;
            const fRit = ui.rit.value;

            document.querySelectorAll('.spell-row').forEach(row => {
                const d = row.dataset;
                const matchName = !q || d.name.includes(q);
                const matchLvl = fLvl === 'all' || d.lvl === fLvl;
                const matchSch = fSch === 'all' || d.sch === fSch;
                const matchCls = fCls === 'all' || d.cls.includes(fCls);
                const matchConc = fConc === 'all' || d.conc === fConc;
                const matchRit = fRit === 'all' || d.rit === fRit;

                if (matchName && matchLvl && matchSch && matchCls && matchConc && matchRit) {
                    row.classList.remove('hidden');
                } else {
                    row.classList.add('hidden');
                }
            });
        }

        // --- HTML Helpers ---
        function getCompTags(s) {
            let h = '';
            if (s.Verbal === "true") h += '<span class="tag t-v" title="Verbal">V</span>';
            if (s.Somatique === "true") h += '<span class="tag t-s" title="Somatique">S</span>';
            if (s.Mat√©riel === "true") h += `<span class="tag t-m ${s.isCostly ? 'costly' : ''}" title="Mat√©riel: ${(s.detailmat||'').replace(/"/g,"&quot;")}">M</span>`;
            if (s.Concentration === "true") h += '<span class="tag t-c" title="Concentration">C</span>';
            if (s.Rituel === "true") h += '<span class="tag t-r" title="Rituel">R</span>';
            return h;
        }

        function getClassTags(list) {
            if (list.length <= 3) return list.map(c => `<span class="tag t-cls">${c}</span>`).join(' ');
            return list.slice(0, 3).map(c => `<span class="tag t-cls">${c}</span>`).join(' ') +
                   `<span class="more-cls" title="${list.slice(3).join(', ')}">+${list.length - 3}</span>`;
        }

        // --- Modal ---
        window.openSpell = (id) => {
            const s = allSpells.find(x => x.id === id);
            if (!s) return;

            const url = `${URL_BASE}${s.levelInt === 0 ? 'cantrips' : '0'+s.levelInt}/${encodeURIComponent(s.name)}/`;

            document.getElementById('m-title').innerHTML = `${s.name} <a href="${url}" class="action-link">üìñ</a> <small style="opacity:0.6;font-weight:normal;font-size:0.7em">(${s.englishname})</small>`;

            let meta = `<strong>Niveau ${s.level} - ${s.school}</strong><br>
            <strong>Temps:</strong> ${s.Incantation} | <strong>Port√©e:</strong> ${s.Port√©e} | <strong>Dur√©e:</strong> ${s.Dur√©e}<br>
            <strong>Composantes:</strong> ${getCompTags(s).replace(/class="tag /g, 'class="tag ')}<br>
            <div style="margin-top:5px"><strong>Classes:</strong> ${s.classes.map(c => `<span class="tag t-cls">${c}</span>`).join(' ')}</div>`;

            if (s.detailmat) meta += `<div style="font-size:0.9em;margin-top:5px;opacity:0.8">Mat√©riel: ${s.detailmat}</div>`;

            document.getElementById('m-meta').innerHTML = meta;
            document.getElementById('m-desc').innerHTML = (s.description || '').replace(/\*\*(.*?)\*\*/g, '<b>$1</b>').replace(/\n/g, '<br>');

            ui.modal.style.display = 'block';
        };

        function checkHash() {
            const hash = window.location.hash.substring(1);
            const target = allSpells.find(s => s.slug === hash);
            if (target) window.openSpell(target.id);
        }

        ui.modal.querySelector('.close-btn').onclick = () => ui.modal.style.display = 'none';
        window.onclick = e => { if (e.target === ui.modal) ui.modal.style.display = 'none'; };

    })();
    </script>
</div>