<div class="spells-app">

    <style>
        /* CSS Scoped pour ne pas casser le thème MkDocs */
        .spells-app {
            font-size: 0.9rem;
            color: var(--md-text-color, #333);
        }

        /* Contrôles */
        .spells-app .controls {
            background: var(--md-code-bg-color, #f5f5f5);
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: flex-end;
            border: 1px solid var(--md-default-fg-color--lightest, #ddd);
        }

        .spells-app .control-group {
            display: flex;
            flex-direction: column;
            flex: 1 1 auto;
        }

        .spells-app label {
            font-size: 0.8em;
            font-weight: bold;
            margin-bottom: 4px;
            opacity: 0.8;
        }

        .spells-app input, .spells-app select {
            padding: 6px;
            border: 1px solid #ccc;
            border-radius: 3px;
            background: var(--md-bg-color, #fff);
            color: var(--md-text-color, #000);
        }

        /* Tableau */
        .spells-app .table-container {
            overflow-x: auto;
            border: 1px solid var(--md-default-fg-color--lightest, #eee);
            border-radius: 4px;
        }

        .spells-app table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px; /* Force le scroll horizontal sur mobile */
        }

        .spells-app th {
            background-color: var(--md-primary-fg-color, #5c6bc0);
            color: white;
            padding: 10px;
            text-align: left;
            cursor: pointer;
            white-space: nowrap;
            user-select: none;
        }
        
        .spells-app th:hover {
            opacity: 0.9;
        }

        .spells-app td {
            padding: 8px 10px;
            border-bottom: 1px solid var(--md-default-fg-color--lightest, #eee);
            vertical-align: middle;
        }

        .spells-app tr:nth-child(even) {
            background-color: var(--md-code-bg-color, #fafafa);
        }
        
        .spells-app tr:hover {
            background-color: rgba(0,0,0,0.05);
        }

        /* Tags et Badges */
        .spells-app .tag {
            display: inline-block;
            padding: 1px 5px;
            border-radius: 3px;
            font-size: 0.8em;
            margin: 1px;
            background: #e0e0e0;
            color: #333;
            font-weight: 500;
        }

        .spells-app .tag-V { color: #c62828; background: #ffcdd2; }
        .spells-app .tag-S { color: #1565c0; background: #bbdefb; }
        .spells-app .tag-M { color: #2e7d32; background: #c8e6c9; }
        
        /* Style spécial pour M coûteux/consommé */
        .spells-app .tag-M.costly {
            font-weight: 900;
            border: 1px solid #2e7d32;
            background: #a5d6a7;
            text-decoration: underline dotted;
        }

        .spells-app .tag-conc { background: #fff9c4; color: #fbc02d; font-weight: bold; }
        .spells-app .tag-rit { background: #e1bee7; color: #8e24aa; }

        /* Modal */
        .spells-modal {
            display: none;
            position: fixed;
            z-index: 9999;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.6);
            backdrop-filter: blur(2px);
        }

        .spells-modal-content {
            background-color: var(--md-bg-color, #fff);
            color: var(--md-text-color, #000);
            margin: 5% auto;
            padding: 25px;
            border-radius: 5px;
            width: 90%;
            max-width: 700px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            position: relative;
        }

        .spells-close {
            position: absolute;
            right: 20px;
            top: 15px;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            color: #888;
        }
        .spells-close:hover { color: #000; }

        .spells-meta {
            font-style: italic;
            color: var(--md-default-fg-color--light, #666);
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
            margin-bottom: 15px;
        }
    </style>

    <div class="controls">
        <div class="control-group">
            <label>Recherche</label>
            <input type="text" id="spells-search" placeholder="Nom du sort..." disabled>
        </div>
        <div class="control-group">
            <label>Niveau</label>
            <select id="spells-level" disabled>
                <option value="all">Tous</option>
                <option value="0">Cantrip (0)</option>
                <option value="1">Niveau 1</option>
                <option value="2">Niveau 2</option>
                <option value="3">Niveau 3</option>
                <option value="4">Niveau 4</option>
                <option value="5">Niveau 5</option>
                <option value="6">Niveau 6</option>
                <option value="7">Niveau 7</option>
                <option value="8">Niveau 8</option>
                <option value="9">Niveau 9</option>
            </select>
        </div>
        <div class="control-group">
            <label>École</label>
            <select id="spells-school" disabled>
                <option value="all">Toutes</option>
            </select>
        </div>
        <div class="control-group">
            <label>Classe</label>
            <select id="spells-class" disabled>
                <option value="all">Toutes</option>
            </select>
        </div>
        <div class="control-group">
            <label>Concentration</label>
            <select id="spells-conc" disabled>
                <option value="all">Peu importe</option>
                <option value="true">Oui</option>
                <option value="false">Non</option>
            </select>
        </div>
    </div>

    <div class="table-container">
        <table id="spells-table">
            <thead>
                <tr>
                    <th onclick="sortSpells('level')" title="Trier par niveau">Niv.</th>
                    <th onclick="sortSpells('name')" title="Trier par nom">Nom</th>
                    <th onclick="sortSpells('school')" title="Trier par école">École</th>
                    <th>Temps</th>
                    <th>Comp.</th>
                    <th>Classes</th>
                </tr>
            </thead>
            <tbody id="spells-body">
                <tr><td colspan="6" style="text-align:center; padding: 20px;">Chargement du grimoire...</td></tr>
            </tbody>
        </table>
    </div>

    <div id="spells-modal" class="spells-modal">
        <div class="spells-modal-content">
            <span class="spells-close">&times;</span>
            <h2 id="modal-title" style="margin-top:0;"></h2>
            <div id="modal-meta" class="spells-meta"></div>
            <div id="modal-desc"></div>
        </div>
    </div>

    <script>
    (function() { // Isolation du scope JS
        const JSON_URL = 'https://eostrebis.github.io/5e.VF/spells.json';
        let spellsData = [];
        let currentSort = { column: 'level', direction: 'asc' }; // Tri par défaut : Niveau croissant

        // Éléments DOM avec préfixe unique pour éviter les conflits
        const inputs = {
            search: document.getElementById('spells-search'),
            level: document.getElementById('spells-level'),
            school: document.getElementById('spells-school'),
            cls: document.getElementById('spells-class'),
            conc: document.getElementById('spells-conc')
        };
        const tbody = document.getElementById('spells-body');
        const modal = document.getElementById('spells-modal');
        const closeBtn = modal.querySelector('.spells-close');

        // Mapping pour nettoyer les noms de classes
        const classMapping = {
            "MagedeGuerre": "Mage de Guerre",
            "MaitreGuerre": "Maître de Guerre"
            // Ajoutez d'autres corrections ici si nécessaire
        };

        function formatClassName(name) {
            return classMapping[name] || name;
        }

        // --- Fetch & Init ---
        fetch(JSON_URL)
            .then(res => res.json())
            .then(data => {
                spellsData = Object.entries(data).map(([key, val]) => {
                    // Analyse des coûts matériels pour le style
                    const details = (val.detailmat || '').toLowerCase();
                    const isCostly = details.includes('consomme') || details.includes('po') || details.includes('vaut');

                    return {
                        id: key,
                        name: key,
                        ...val,
                        levelInt: parseInt(val.level), // Pour le tri numérique
                        isCostly: isCostly,
                        // On nettoie les classes ici
                        cleanClasses: (val.available || []).map(c => formatClassName(c))
                    };
                });

                // Trier par défaut : Cantrip (0) -> Niv 9
                sortData('level');

                initFilters();
                renderTable(spellsData);
                
                // Activer inputs
                Object.values(inputs).forEach(el => el.disabled = false);
            })
            .catch(err => {
                tbody.innerHTML = `<tr><td colspan="6" style="color:red; text-align:center;">Erreur chargement: ${err.message}</td></tr>`;
            });

        // --- Logique ---
        function initFilters() {
            const schools = new Set();
            const classes = new Set();

            spellsData.forEach(s => {
                if(s.school) schools.add(s.school);
                s.cleanClasses.forEach(c => classes.add(c));
            });

            Array.from(schools).sort().forEach(s => {
                inputs.school.innerHTML += `<option value="${s}">${s}</option>`;
            });
            Array.from(classes).sort().forEach(c => {
                inputs.cls.innerHTML += `<option value="${c}">${c}</option>`;
            });
        }

        function renderTable(data) {
            tbody.innerHTML = '';
            if(!data.length) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">Aucun sort trouvé.</td></tr>';
                return;
            }

            const fragment = document.createDocumentFragment();
            
            data.forEach(spell => {
                const tr = document.createElement('tr');
                tr.style.cursor = 'pointer';
                tr.onclick = () => openModal(spell);

                // Composantes
                let comps = '';
                if(spell.Verbal === "true") comps += '<span class="tag tag-V" title="Verbal">V</span>';
                if(spell.Somatique === "true") comps += '<span class="tag tag-S" title="Somatique">S</span>';
                
                // Logique Matériel Gras/Souligné
                if(spell.Matériel === "true") {
                    const styleClass = spell.isCostly ? 'tag tag-M costly' : 'tag tag-M';
                    const title = spell.detailmat ? `Matériel: ${spell.detailmat}` : 'Matériel';
                    comps += `<span class="${styleClass}" title="${title.replace(/"/g, '&quot;')}">M</span>`;
                }

                if(spell.Concentration === "true") comps += '<span class="tag tag-conc" title="Concentration">C</span>';
                if(spell.Rituel === "true") comps += '<span class="tag tag-rit" title="Rituel">R</span>';

                // Classes (limité à 3 pour l'affichage tableau, reste dans modal)
                let classDisplay = spell.cleanClasses.slice(0, 3).map(c => `<span class="tag" style="background:#fff; border:1px solid #ccc;">${c}</span>`).join(' ');
                if(spell.cleanClasses.length > 3) classDisplay += ' <small>...</small>';

                tr.innerHTML = `
                    <td style="text-align:center; font-weight:bold;">${spell.level === "0" ? "C" : spell.level}</td>
                    <td style="font-weight:500; color:var(--md-primary-fg-color, #3f51b5);">${spell.name}</td>
                    <td>${spell.school}</td>
                    <td>${spell.Incantation}</td>
                    <td style="white-space:nowrap;">${comps}</td>
                    <td>${classDisplay}</td>
                `;
                fragment.appendChild(tr);
            });
            tbody.appendChild(fragment);
        }

        function filterSpells() {
            const terms = inputs.search.value.toLowerCase();
            const fLvl = inputs.level.value;
            const fSch = inputs.school.value;
            const fCls = inputs.cls.value;
            const fConc = inputs.conc.value;

            const filtered = spellsData.filter(s => {
                const matchName = s.name.toLowerCase().includes(terms) || (s.englishname && s.englishname.toLowerCase().includes(terms));
                const matchLvl = fLvl === 'all' || s.level === fLvl;
                const matchSch = fSch === 'all' || s.school === fSch;
                const matchCls = fCls === 'all' || s.cleanClasses.includes(fCls);
                const matchConc = fConc === 'all' || s.Concentration === fConc;
                return matchName && matchLvl && matchSch && matchCls && matchConc;
            });

            // Ré-appliquer le tri actuel sur les données filtrées
            const sorted = sortDataList(filtered, currentSort.column, currentSort.direction);
            renderTable(sorted);
        }

        // --- Tri ---
        window.sortSpells = function(col) {
            // Inversion direction si même colonne
            if(currentSort.column === col) {
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.column = col;
                currentSort.direction = 'asc';
            }
            filterSpells(); // Relance le rendu avec le nouveau tri
        };

        function sortData(col) {
            spellsData = sortDataList(spellsData, col, 'asc');
        }

        function sortDataList(list, col, dir) {
            return list.sort((a, b) => {
                let valA, valB;
                
                // Tri spécial pour niveau (numérique)
                if (col === 'level') {
                    valA = a.levelInt;
                    valB = b.levelInt;
                } else {
                    valA = a[col] ? a[col].toString().toLowerCase() : '';
                    valB = b[col] ? b[col].toString().toLowerCase() : '';
                }

                if(valA < valB) return dir === 'asc' ? -1 : 1;
                if(valA > valB) return dir === 'asc' ? 1 : -1;
                return 0;
            });
        }

        // --- Modal ---
        function openModal(s) {
            document.getElementById('modal-title').textContent = `${s.name} ${s.englishname ? `(${s.englishname})` : ''}`;
            
            let meta = `<strong>Niveau ${s.level} - ${s.school}</strong><br>`;
            meta += `<strong>Temps:</strong> ${s.Incantation} | <strong>Portée:</strong> ${s.Portée} | <strong>Durée:</strong> ${s.Durée}<br>`;
            
            // Détail composantes modal
            let compDetails = [];
            if(s.Verbal === "true") compDetails.push("Verbal");
            if(s.Somatique === "true") compDetails.push("Somatique");
            if(s.Matériel === "true") compDetails.push(`Matériel (${s.detailmat || '?'})`);
            meta += `<strong>Composantes:</strong> ${compDetails.join(', ')}`;
            
            // Liste complète des classes dans le modal
            meta += `<br><strong>Classes:</strong> ${s.cleanClasses.join(', ')}`;

            document.getElementById('modal-meta').innerHTML = meta;
            
            // Description formatting
            let desc = s.description || '';
            desc = desc.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                       .replace(/__(.*?)__/g, '<strong>$1</strong>')
                       .replace(/\[\[(.*?)\]\]/g, '$1')
                       .replace(/\n/g, '<br>');
            
            document.getElementById('modal-desc').innerHTML = desc;
            modal.style.display = 'block';
        }

        closeBtn.onclick = () => modal.style.display = 'none';
        window.onclick = (e) => { if(e.target === modal) modal.style.display = 'none'; };

        // Events inputs
        Object.values(inputs).forEach(i => i.addEventListener('input', filterSpells));

    })(); // Fin IIFE
    </script>
</div>