<div class="spells-app">

    <style>
        /* --- CSS Scoped & Variables --- */
        .spells-app {
            --text-main: var(--md-typeset-color, #333);
            --bg-main: var(--md-default-bg-color, #fff);
            --border: var(--md-default-fg-color--lightest, #eee);
            --primary: var(--md-primary-fg-color, #5c6bc0);

            /* Couleurs des Tags (D√©faut Clair) */
            --tag-v-bg: #ffcdd2; --tag-v-fg: #b71c1c;
            --tag-s-bg: #bbdefb; --tag-s-fg: #0d47a1;
            --tag-m-bg: #c8e6c9; --tag-m-fg: #1b5e20;
            --tag-c-bg: #ffe0b2; --tag-c-fg: #e65100;
            --tag-r-bg: #e1bee7; --tag-r-fg: #4a148c;

            font-size: 0.9rem;
            color: var(--text-main);
            margin: 0 auto;
            max-width: 100%;
        }

        /* Mode Sombre : On red√©finit juste les variables */
        body[data-md-color-scheme="slate"] .spells-app {
            --tag-v-bg: rgba(183, 28, 28, 0.3); --tag-v-fg: #ffcdd2;
            --tag-s-bg: rgba(13, 71, 161, 0.3); --tag-s-fg: #bbdefb;
            --tag-m-bg: rgba(27, 94, 32, 0.3);  --tag-m-fg: #c8e6c9;
            --tag-c-bg: rgba(230, 81, 0, 0.3);  --tag-c-fg: #ffe0b2;
            --tag-r-bg: rgba(74, 20, 140, 0.3); --tag-r-fg: #e1bee7;
        }

        .spells-app a { color: var(--md-typeset-a-color, #3f51b5); text-decoration: none; }
        .spells-app a:hover { text-decoration: underline; }

        /* Interface */
        .controls {
            background: var(--bg-main); border: 1px solid var(--border);
            padding: 15px; border-radius: 4px; margin-bottom: 20px;
            display: flex; gap: 15px; flex-wrap: wrap; justify-content: center;
        }
        .control-group { display: flex; flex-direction: column; flex: 1 1 auto; min-width: 120px; }
        .control-group label { font-weight: bold; font-size: 0.8em; opacity: 0.8; margin-bottom: 4px; color: var(--text-main); }

        input, select {
            padding: 6px; border: 1px solid #ccc; border-radius: 3px;
            background: var(--bg-main); color: var(--text-main);
        }

        input:focus, select:focus { border-color: var(--primary); outline: none; }

        /* Tableau */
        .table-wrap {
            overflow-x: auto; border: 1px solid var(--border); border-radius: 4px;
            display: flex; justify-content: center; background: var(--bg-main);
        }
        table { width: 100%; border-collapse: collapse; min-width: 800px; margin: 0 auto; }

        th {
            background: var(--primary); color: #fff; padding: 10px; text-align: left;
            cursor: pointer; user-select: none; position: relative;
        }
        th:hover { opacity: 0.9; }

        /* Fl√®ches de tri */
        th[data-col].asc::after { content: '‚ñ≤'; position: absolute; right: 5px; opacity: 0.5; font-size: 0.8em; }
        th[data-col].desc::after { content: '‚ñº'; position: absolute; right: 5px; opacity: 0.5; font-size: 0.8em; }

        td { padding: 8px 10px; border-bottom: 1px solid var(--border); vertical-align: middle; color: var(--text-main); }
        tr:nth-child(even) { background: rgba(128,128,128, 0.05); }
        tr:hover { background: rgba(128,128,128, 0.1); cursor: pointer; }

        /* Badges */
        .tag {
            display: inline-block; padding: 2px 6px; border-radius: 4px;
            font-size: 0.75em; font-weight: 700; margin: 1px;
            border: 1px solid transparent;
        }
        .t-v { background: var(--tag-v-bg); color: var(--tag-v-fg); border-color: var(--tag-v-fg); }
        .t-s { background: var(--tag-s-bg); color: var(--tag-s-fg); border-color: var(--tag-s-fg); }
        .t-m { background: var(--tag-m-bg); color: var(--tag-m-fg); border-color: var(--tag-m-fg); }
        .t-c { background: var(--tag-c-bg); color: var(--tag-c-fg); border-color: var(--tag-c-fg); }
        .t-r { background: var(--tag-r-bg); color: var(--tag-r-fg); border-color: var(--tag-r-fg); }

        .t-m.costly { border-width: 2px; text-decoration: underline dotted; }

        .t-cls { border: 1px solid #ccc; background: var(--bg-main); color: var(--text-main); font-weight: normal; }
        .more-cls { cursor: help; border-bottom: 1px dotted; margin-left: 5px; font-weight: bold; opacity: 0.6; color: var(--text-main); }

        /* Modal */
        .modal-overlay {
            display: none; position: fixed; z-index: 9999; left: 0; top: 0;
            width: 100%; height: 100%; background: rgba(0,0,0,0.75); backdrop-filter: blur(2px);
        }
        .modal-box {
            background: var(--bg-main); margin: 5% auto; padding: 25px;
            width: 90%; max-width: 700px; max-height: 85vh; overflow-y: auto;
            border-radius: 6px; position: relative; box-shadow: 0 10px 25px rgba(0,0,0,0.5);
            color: var(--text-main);
        }
        .close-btn { position: absolute; right: 20px; top: 15px; font-size: 24px; cursor: pointer; opacity: 0.6; }
        .meta-info { font-style: italic; opacity: 0.8; border-bottom: 1px solid var(--border); padding-bottom: 15px; margin-bottom: 15px; line-height: 1.6; }
        .action-link { font-size: 0.8em; margin-left: 8px; opacity: 0.4; text-decoration: none; display: inline-block; vertical-align: middle; }
        .action-link:hover { opacity: 1; transform: scale(1.1); }
    </style>

    <div class="controls">
        <div class="control-group"><label>Recherche</label><input type="text" id="s-search" placeholder="Nom..." disabled></div>
        <div class="control-group"><label>Niveau</label><select id="s-lvl" disabled><option value="all">Tous</option></select></div>
        <div class="control-group"><label>√âcole</label><select id="s-sch" disabled><option value="all">Toutes</option></select></div>
        <div class="control-group"><label>Classe</label><select id="s-cls" disabled><option value="all">Toutes</option></select></div>
        <div class="control-group"><label>Conc.</label><select id="s-conc" disabled><option value="all">-</option><option value="true">Oui</option><option value="false">Non</option></select></div>
        <div class="control-group"><label>Rituel</label><select id="s-rit" disabled><option value="all">-</option><option value="true">Oui</option><option value="false">Non</option></select></div>
    </div>

    <div class="table-wrap">
        <table id="spells-table">
            <thead>
                <tr>
                    <th data-col="levelInt" class="sorter-false">Niv.</th>
                    <th data-col="normName" class="sorter-false">Nom</th>
                    <th data-col="normSchool" class="sorter-false">√âcole</th>
                    <th data-col="normTime" class="sorter-false">Temps</th>
                    <th class="sorter-false">Comp.</th>
                    <th class="sorter-false">Classes</th>
                </tr>
            </thead>
            <tbody id="spells-body">
                <tr><td colspan="6" style="text-align:center; padding: 20px;">Chargement...</td></tr>
            </tbody>
        </table>
    </div>

    <div id="spells-modal" class="modal-overlay">
        <div class="modal-box">
            <span class="close-btn">&times;</span>
            <h2 id="m-title" style="margin-top:0; color:var(--primary); padding-right:30px;"></h2>
            <div id="m-meta" class="meta-info"></div>
            <div id="m-desc"></div>
        </div>
    </div>

    <script>
    (function() {
        const URL_DATA = 'https://eostrebis.github.io/5e.VF/spells.json';
        const URL_BASE = 'https://eostrebis.github.io/5e.VF/sorts/';

        let allSpells = [];
        let sortCol = 'levelInt';
        let sortAsc = true;

        const ui = {
            search: document.getElementById('s-search'),
            lvl: document.getElementById('s-lvl'),
            sch: document.getElementById('s-sch'),
            cls: document.getElementById('s-cls'),
            conc: document.getElementById('s-conc'),
            rit: document.getElementById('s-rit'),
            tbody: document.getElementById('spells-body'),
            modal: document.getElementById('spells-modal'),
            headers: document.querySelectorAll('#spells-table th[data-col]')
        };

        // --- Helpers Normalisation ---
        const normalize = t => t ? t.toString().toLowerCase().replace(/≈ì/g, "oe").replace(/√¶/g, "ae").normalize("NFD").replace(/[\u0300-\u036f]/g, "") : "";
        const slugify = t => normalize(t).replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)+/g, '');
        const formatClass = c => ({ "MagedeGuerre": "Mage de Guerre", "MaitreGuerre": "Ma√Ætre de Guerre" }[c] || c);

        // --- Fetch ---
        fetch(URL_DATA).then(r => r.json()).then(data => {
            allSpells = Object.entries(data).map(([k, v]) => {
                const lvl = parseInt(v.level) || 0;
                return {
                    id: k, name: k, slug: slugify(k), ...v,
                    levelInt: lvl,
                    // Pr√©-calcul des valeurs normalis√©es pour le tri/filtre
                    normName: normalize(k),
                    normEng: normalize(v.englishname),
                    normSchool: normalize(v.school),
                    normTime: normalize(v.Incantation),
                    classes: (v.available || []).map(formatClass),
                    isCostly: (v.detailmat || '').toLowerCase().match(/consomme|po|vaut/)
                };
            });

            // Remplissage Selects
            [0,1,2,3,4,5,6,7,8,9].forEach(l => ui.lvl.add(new Option(l === 0 ? "Cantrip (0)" : `Niveau ${l}`, l)));
            [...new Set(allSpells.map(s => s.school).filter(Boolean))].sort().forEach(s => ui.sch.add(new Option(s, s)));
            [...new Set(allSpells.flatMap(s => s.classes))].sort().forEach(c => ui.cls.add(new Option(c, c)));

            Object.values(ui).forEach(el => el instanceof HTMLElement && (el.disabled = false));

            // Events
            ui.headers.forEach(th => th.addEventListener('click', () => {
                const col = th.dataset.col;
                if (sortCol === col) sortAsc = !sortAsc;
                else { sortCol = col; sortAsc = true; }
                render();
            }));

            [ui.search, ui.lvl, ui.sch, ui.cls, ui.conc, ui.rit].forEach(el => el.addEventListener('input', render));

            checkHash();
            render();
        }).catch(e => ui.tbody.innerHTML = `<tr><td colspan="6" style="color:red;text-align:center">Erreur: ${e.message}</td></tr>`);

        // --- Rendu ---
        function render() {
            const q = normalize(ui.search.value);
            const filtered = allSpells.filter(s => {
                if (q && !s.normName.includes(q) && !s.normEng.includes(q)) return false;
                if (ui.lvl.value !== 'all' && s.levelInt != ui.lvl.value) return false;
                if (ui.sch.value !== 'all' && s.school !== ui.sch.value) return false;
                if (ui.cls.value !== 'all' && !s.classes.includes(ui.cls.value)) return false;
                if (ui.conc.value !== 'all' && s.Concentration !== ui.conc.value) return false;
                if (ui.rit.value !== 'all' && s.Rituel !== ui.rit.value) return false;
                return true;
            });

            // Tri optimis√© sur les valeurs normalis√©es
            filtered.sort((a, b) => {
                let res = 0;
                if (sortCol === 'levelInt') res = a.levelInt - b.levelInt;
                else res = a[sortCol].localeCompare(b[sortCol], 'fr', { numeric: true });
                return sortAsc ? res : -res;
            });

            ui.headers.forEach(th => {
                th.classList.remove('asc', 'desc');
                if (th.dataset.col === sortCol) th.classList.add(sortAsc ? 'asc' : 'desc');
            });

            if (!filtered.length) {
                ui.tbody.innerHTML = '<tr><td colspan="6" style="text-align:center">Aucun r√©sultat</td></tr>';
                return;
            }

            // G√©n√©ration avec data-sort sur les TD
            ui.tbody.innerHTML = filtered.map(s => `
                <tr onclick="window.openSpell('${s.id}')">
                    <td data-sort="${s.levelInt}" style="text-align:center;font-weight:bold">${s.levelInt === 0 ? 'C' : s.levelInt}</td>
                    <td data-sort="${s.normName}" style="font-weight:500;color:var(--primary)">${s.name}</td>
                    <td data-sort="${s.normSchool}">${s.school}</td>
                    <td data-sort="${s.normTime}">${s.Incantation}</td>
                    <td style="white-space:nowrap">${getCompTags(s)}</td>
                    <td>${getClassTags(s.classes)}</td>
                </tr>
            `).join('');
        }

        function getCompTags(s) {
            let h = '';
            if (s.Verbal === "true") h += '<span class="tag t-v" title="Verbal">V</span>';
            if (s.Somatique === "true") h += '<span class="tag t-s" title="Somatique">S</span>';
            if (s.Mat√©riel === "true") h += `<span class="tag t-m ${s.isCostly ? 'costly' : ''}" title="Mat√©riel: ${(s.detailmat||'').replace(/"/g,"&quot;")}">M</span>`;
            if (s.Concentration === "true") h += '<span class="tag t-c" title="Concentration">C</span>';
            if (s.Rituel === "true") h += '<span class="tag t-r" title="Rituel">R</span>';
            return h;
        }

        function getClassTags(list) {
            if (list.length <= 3) return list.map(c => `<span class="tag t-cls">${c}</span>`).join(' ');
            return list.slice(0, 3).map(c => `<span class="tag t-cls">${c}</span>`).join(' ') +
                   `<span class="more-cls" title="${list.slice(3).join(', ')}">+${list.length - 3}</span>`;
        }

        window.openSpell = (id) => {
            const s = allSpells.find(x => x.id === id);
            if (!s) return;

            const url = `${URL_BASE}${s.levelInt === 0 ? 'cantrips' : '0'+s.levelInt}/${encodeURIComponent(s.name)}/`;

            document.getElementById('m-title').innerHTML = `${s.name} <a href="${url}" class="action-link">üìñ</a> <small style="opacity:0.6;font-weight:normal;font-size:0.7em">(${s.englishname})</small>`;

            let meta = `<strong>Niveau ${s.level} - ${s.school}</strong><br>
            <strong>Temps:</strong> ${s.Incantation} | <strong>Port√©e:</strong> ${s.Port√©e} | <strong>Dur√©e:</strong> ${s.Dur√©e}<br>
            <strong>Composantes:</strong> ${getCompTags(s).replace(/class="tag /g, 'class="tag ')}<br>
            <div style="margin-top:5px"><strong>Classes:</strong> ${s.classes.map(c => `<span class="tag t-cls">${c}</span>`).join(' ')}</div>`;

            if (s.detailmat) meta += `<div style="font-size:0.9em;margin-top:5px;opacity:0.8">Mat√©riel: ${s.detailmat}</div>`;

            document.getElementById('m-meta').innerHTML = meta;
            document.getElementById('m-desc').innerHTML = (s.description || '').replace(/\*\*(.*?)\*\*/g, '<b>$1</b>').replace(/\n/g, '<br>');

            ui.modal.style.display = 'block';
        };

        function checkHash() {
            const hash = window.location.hash.substring(1);
            const target = allSpells.find(s => s.slug === hash);
            if (target) window.openSpell(target.id);
        }

        ui.modal.querySelector('.close-btn').onclick = () => ui.modal.style.display = 'none';
        window.onclick = e => { if (e.target === ui.modal) ui.modal.style.display = 'none'; };

    })();
    </script>
</div>